{% extends "admin/base.html" %}

{% block title %}用户管理 - MedChina Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-people"></i> 用户管理</h3>
    <button class="btn btn-primary" onclick="showCreateModal()">
        <i class="bi bi-plus-lg"></i> 新增用户
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table id="usersTable" class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>姓名</th>
                        <th>邮箱</th>
                        <th>手机</th>
                        <th>国家</th>
                        <th>状态</th>
                        <th>注册时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">新增用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">姓名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">邮箱 <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">手机号码</label>
                            <input type="text" class="form-control" id="userPhone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">护照号码</label>
                            <input type="text" class="form-control" id="userPassport">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">国家</label>
                            <input type="text" class="form-control" id="userCountry">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">语言</label>
                            <select class="form-select" id="userLanguage">
                                <option value="en">English</option>
                                <option value="de">Deutsch</option>
                                <option value="fr">Français</option>
                                <option value="es">Español</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">状态</label>
                        <select class="form-select" id="userStatus">
                            <option value="active">活跃</option>
                            <option value="inactive">非活跃</option>
                            <option value="pending">待审核</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let usersTable;

$(document).ready(function() {
    initializeUsersTable();
});

function initializeUsersTable() {
    usersTable = $('#usersTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/admin/api/users',
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('admin_token'));
            },
            data: function(d) {
                // Add any additional filters here
                return d;
            }
        },
        columns: [
            { data: 'id' },
            { data: 'name' },
            { data: 'email' },
            { data: 'phone' },
            { data: 'country' },
            { 
                data: 'status',
                render: function(data) {
                    const statusMap = {
                        'active': '<span class="badge bg-success">活跃</span>',
                        'inactive': '<span class="badge bg-secondary">非活跃</span>',
                        'pending': '<span class="badge bg-warning">待审核</span>'
                    };
                    return statusMap[data] || data;
                }
            },
            { 
                data: 'created_at',
                render: function(data) {
                    return formatDate(data);
                }
            },
            {
                data: null,
                render: function(data, type, row) {
                    return `
                        <button class="btn btn-sm btn-primary" onclick="editUser(${row.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${row.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                }
            }
        ],
        language: {
            processing: '处理中...',
            search: '搜索:',
            lengthMenu: '显示 _MENU_ 条记录',
            info: '显示第 _START_ 至 _END_ 条记录，共 _TOTAL_ 条',
            infoEmpty: '没有记录',
            infoFiltered: '(从 _MAX_ 条记录中过滤)',
            paginate: {
                first: '首页',
                previous: '上一页',
                next: '下一页',
                last: '末页'
            }
        },
        pageLength: 20,
        lengthMenu: [10, 20, 50, 100]
    });
}

function showCreateModal() {
    $('#userModalTitle').text('新增用户');
    $('#userForm')[0].reset();
    $('#userId').val('');
    new bootstrap.Modal(document.getElementById('userModal')).show();
}

function editUser(userId) {
    apiRequest('/admin/api/users/' + userId, 'GET', null, function(response) {
        if (response.success) {
            const user = response.data;
            $('#userModalTitle').text('编辑用户');
            $('#userId').val(user.id);
            $('#userName').val(user.name);
            $('#userEmail').val(user.email);
            $('#userPhone').val(user.phone || '');
            $('#userPassport').val(user.passport_number || '');
            $('#userCountry').val(user.country || '');
            $('#userLanguage').val(user.language);
            $('#userStatus').val(user.status);
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }
    });
}

function saveUser() {
    const userId = $('#userId').val();
    const userData = {
        name: $('#userName').val(),
        email: $('#userEmail').val(),
        phone: $('#userPhone').val() || null,
        passport_number: $('#userPassport').val() || null,
        country: $('#userCountry').val() || null,
        language: $('#userLanguage').val(),
        status: $('#userStatus').val()
    };
    
    if (!userData.name || !userData.email) {
        showAlert('姓名和邮箱为必填项', 'warning');
        return;
    }
    
    const url = userId ? '/admin/api/users/' + userId : '/admin/api/users';
    const method = userId ? 'PUT' : 'POST';
    
    apiRequest(url, method, userData, function(response) {
        if (response.success) {
            showAlert(userId ? '用户更新成功' : '用户创建成功', 'success');
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            usersTable.ajax.reload();
        }
    });
}

function deleteUser(userId) {
    if (confirm('确定要删除该用户吗？此操作不可撤销。')) {
        apiRequest('/admin/api/users/' + userId, 'DELETE', null, function(response) {
            if (response.success) {
                showAlert('用户删除成功', 'success');
                usersTable.ajax.reload();
            }
        });
    }
}
</script>
{% endblock %}
